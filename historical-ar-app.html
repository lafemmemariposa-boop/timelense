<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-secure=no">
    <title>TimeLens - See History Through Your Phone</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            overflow: hidden;
            background: #000;
        }

        #video-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 1;
        }

        #camera-feed {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #ar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }

        #ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 3;
            pointer-events: none;
        }

        #ui-container > * {
            pointer-events: auto;
        }

        .header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
            padding: 20px;
            color: white;
        }

        .app-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .location-info {
            font-size: 14px;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4ade80;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .controls {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 30px 20px;
            background: linear-gradient(to top, rgba(0,0,0,0.9), transparent);
        }

        .time-slider-container {
            margin-bottom: 25px;
        }

        .time-label {
            color: white;
            font-size: 18px;
            font-weight: 600;
            text-align: center;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: rgba(255,255,255,0.3);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .slider::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .button-group {
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.9);
            color: #1f2937;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .info-panel {
            position: absolute;
            top: 100px;
            right: 20px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 15px;
            border-radius: 12px;
            max-width: 250px;
            font-size: 14px;
            line-height: 1.6;
            backdrop-filter: blur(10px);
        }

        .info-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            color: white;
        }

        .loading-screen h1 {
            font-size: 36px;
            margin-bottom: 20px;
        }

        .loading-screen p {
            font-size: 18px;
            opacity: 0.9;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px 0;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .distance-indicator {
            position: absolute;
            top: 120px;
            left: 20px;
            background: rgba(0,0,0,0.85);
            color: white;
            padding: 12px 16px;
            border-radius: 12px;
            font-size: 14px;
            backdrop-filter: blur(10px);
        }

        .distance-value {
            font-size: 20px;
            font-weight: 700;
            color: #4ade80;
        }
    </style>
</head>
<body>
    <div id="loading-screen" class="loading-screen">
        <h1>‚è≥ TimeLens</h1>
        <div class="spinner"></div>
        <p>Initializing camera and GPS...</p>
    </div>

    <div id="video-container">
        <video id="camera-feed" autoplay playsinline></video>
    </div>

    <canvas id="ar-overlay"></canvas>

    <div id="ui-container" class="hidden">
        <div class="header">
            <div class="app-title">
                ‚è≥ TimeLens
            </div>
            <div class="location-info">
                <span class="status-indicator"></span>
                <span id="location-text">Searching for historical sites...</span>
            </div>
        </div>

        <div id="distance-indicator" class="distance-indicator hidden">
            <div>Distance to site:</div>
            <div class="distance-value" id="distance-value">--</div>
        </div>

        <div id="info-panel" class="info-panel hidden">
            <div class="info-title" id="site-name">Ancient Rome</div>
            <div id="site-description">
                The Colosseum in its glory days could hold 50,000-80,000 spectators and was used for gladiatorial contests and public spectacles.
            </div>
        </div>

        <div class="controls">
            <div class="time-slider-container">
                <div class="time-label" id="time-label">Present Day (2025)</div>
                <input type="range" min="0" max="100" value="0" class="slider" id="time-slider">
            </div>
            <div class="button-group">
                <button class="btn btn-secondary" id="toggle-info">‚ÑπÔ∏è Info</button>
                <button class="btn btn-primary" id="generate-view">‚ú® Generate Historical View</button>
            </div>
        </div>
    </div>

    <script>
        // App State
        const appState = {
            cameraStream: null,
            currentLocation: null,
            nearestSite: null,
            historicalImageGenerated: false,
            historicalImageUrl: null,
            overlayOpacity: 0,
            sites: [
                {
                    name: "Colosseum, Rome",
                    lat: 41.8902,
                    lon: 12.4922,
                    era: "80 AD",
                    description: "The Colosseum in its glory days could hold 50,000-80,000 spectators and was used for gladiatorial contests and public spectacles. The arena was surrounded by marble seating and featured elaborate underground chambers."
                },
                {
                    name: "Roman Forum",
                    lat: 41.8925,
                    lon: 12.4853,
                    era: "500 BC - 400 AD",
                    description: "The heart of ancient Rome, filled with temples, basilicas, and monuments. Citizens gathered here for public speeches, elections, and triumphal processions."
                },
                {
                    name: "Parthenon, Athens",
                    lat: 37.9715,
                    lon: 23.7267,
                    era: "432 BC",
                    description: "The pinnacle of classical Greek architecture, this temple was dedicated to Athena and featured brilliant white marble columns and elaborate sculptures painted in vibrant colors."
                },
                {
                    name: "Machu Picchu",
                    lat: -13.1631,
                    lon: -72.5450,
                    era: "1450 AD",
                    description: "This Incan citadel sat at 7,970 feet with terraced fields, astronomical observatories, and precisely fitted stone structures without mortar."
                }
            ]
        };

        // DOM Elements
        const elements = {
            loadingScreen: document.getElementById('loading-screen'),
            uiContainer: document.getElementById('ui-container'),
            cameraFeed: document.getElementById('camera-feed'),
            arOverlay: document.getElementById('ar-overlay'),
            timeSlider: document.getElementById('time-slider'),
            timeLabel: document.getElementById('time-label'),
            locationText: document.getElementById('location-text'),
            infoPanel: document.getElementById('info-panel'),
            siteName: document.getElementById('site-name'),
            siteDescription: document.getElementById('site-description'),
            generateBtn: document.getElementById('generate-view'),
            toggleInfoBtn: document.getElementById('toggle-info'),
            distanceIndicator: document.getElementById('distance-indicator'),
            distanceValue: document.getElementById('distance-value')
        };

        // Initialize Camera
        async function initCamera() {
            try {
                const constraints = {
                    video: {
                        facingMode: 'environment',
                        width: { ideal: 1920 },
                        height: { ideal: 1080 }
                    }
                };
                
                appState.cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                elements.cameraFeed.srcObject = appState.cameraStream;
                
                elements.cameraFeed.onloadedmetadata = () => {
                    setupCanvas();
                };
                
                return true;
            } catch (error) {
                console.error('Camera error:', error);
                alert('Unable to access camera. Please grant camera permissions.');
                return false;
            }
        }

        // Setup Canvas for AR Overlay
        function setupCanvas() {
            const canvas = elements.arOverlay;
            const video = elements.cameraFeed;
            
            canvas.width = video.videoWidth || window.innerWidth;
            canvas.height = video.videoHeight || window.innerHeight;
            
            // Redraw on window resize
            window.addEventListener('resize', () => {
                canvas.width = video.videoWidth || window.innerWidth;
                canvas.height = video.videoHeight || window.innerHeight;
            });
        }

        // Calculate distance between two coordinates (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                     Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                     Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // Get user location and find nearest site
        async function initLocation() {
            if (!navigator.geolocation) {
                elements.locationText.textContent = "Geolocation not supported - Using demo mode";
                useDemoLocation();
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    appState.currentLocation = {
                        lat: position.coords.latitude,
                        lon: position.coords.longitude
                    };
                    findNearestSite();
                },
                (error) => {
                    console.error('Location error:', error);
                    elements.locationText.textContent = "Location unavailable - Using demo mode";
                    useDemoLocation();
                }
            );
        }

        // Use demo location (Colosseum) for testing
        function useDemoLocation() {
            appState.currentLocation = {
                lat: 41.8902,
                lon: 12.4922
            };
            findNearestSite();
        }

        // Find nearest historical site
        function findNearestSite() {
            let nearest = null;
            let minDistance = Infinity;

            appState.sites.forEach(site => {
                const distance = calculateDistance(
                    appState.currentLocation.lat,
                    appState.currentLocation.lon,
                    site.lat,
                    site.lon
                );
                
                if (distance < minDistance) {
                    minDistance = distance;
                    nearest = { ...site, distance };
                }
            });

            appState.nearestSite = nearest;
            updateLocationUI();
        }

        // Update location UI
        function updateLocationUI() {
            const site = appState.nearestSite;
            if (!site) return;

            const distanceKm = site.distance.toFixed(2);
            const distanceM = (site.distance * 1000).toFixed(0);
            
            if (site.distance < 0.5) {
                elements.locationText.textContent = `üìç Near ${site.name}`;
                elements.distanceIndicator.classList.remove('hidden');
                elements.distanceValue.textContent = `${distanceM}m`;
            } else if (site.distance < 50) {
                elements.locationText.textContent = `üìç ${distanceKm}km from ${site.name}`;
                elements.distanceIndicator.classList.remove('hidden');
                elements.distanceValue.textContent = `${distanceKm}km`;
            } else {
                elements.locationText.textContent = `üåç ${site.name} (Demo Mode)`;
            }

            elements.siteName.textContent = site.name;
            elements.siteDescription.textContent = site.description;
        }

        // Generate historical view using AI
        async function generateHistoricalView() {
            const site = appState.nearestSite;
            if (!site) return;

            elements.generateBtn.textContent = 'üîÑ Generating...';
            elements.generateBtn.disabled = true;

            try {
                const prompt = `Create a photorealistic reconstruction of ${site.name} as it appeared in ${site.era}. 
                Show the pristine architecture with marble columns, vibrant colors, surrounding buildings, and people in period clothing. 
                Make it look like a professional historical reconstruction with accurate archaeological details. 
                The viewpoint should be from ground level, as if standing in the location looking at the monument.
                Include atmospheric perspective with clear blue skies and natural lighting.`;

                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [
                            {
                                role: "user",
                                content: `I need you to generate a historical reconstruction image. ${prompt}
                                
                                Please provide a detailed description of what this scene would look like that I can use to generate an image, focusing on:
                                - Architecture and structures
                                - Colors and materials
                                - People and daily life
                                - Atmospheric conditions
                                - Specific historical details
                                
                                Make the description vivid and suitable for image generation.`
                            }
                        ]
                    })
                });

                const data = await response.json();
                const description = data.content.find(c => c.type === 'text')?.text || 'Historical scene';

                // For demo purposes, create a colored overlay representing the historical view
                // In production, you'd use the description with an actual image generation API
                appState.historicalImageGenerated = true;
                
                elements.generateBtn.textContent = '‚úÖ View Generated!';
                elements.timeLabel.textContent = `${site.name} - ${site.era}`;
                elements.infoPanel.classList.remove('hidden');
                
                // Store the description for display
                appState.historicalDescription = description;
                
                alert(`Historical reconstruction generated!\n\nUse the time slider to blend between present and ${site.era}.\n\nIn a production version, this would show an actual AI-generated image overlay of the historical scene.`);
                
            } catch (error) {
                console.error('Generation error:', error);
                alert('Unable to generate historical view. Please check your internet connection.');
                elements.generateBtn.textContent = '‚ú® Generate Historical View';
            } finally {
                elements.generateBtn.disabled = false;
            }
        }

        // Update AR overlay based on time slider
        function updateOverlay() {
            const canvas = elements.arOverlay;
            const ctx = canvas.getContext('2d');
            const opacity = appState.overlayOpacity;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (appState.historicalImageGenerated && opacity > 0) {
                // Create a gradient overlay effect representing the historical view
                const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, `rgba(139, 92, 46, ${opacity * 0.3})`);
                gradient.addColorStop(0.5, `rgba(184, 134, 89, ${opacity * 0.4})`);
                gradient.addColorStop(1, `rgba(101, 67, 33, ${opacity * 0.3})`);
                
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Add text overlay
                ctx.fillStyle = `rgba(255, 255, 255, ${opacity * 0.9})`;
                ctx.font = 'bold 24px sans-serif';
                ctx.textAlign = 'center';
                ctx.shadowColor = 'rgba(0,0,0,0.8)';
                ctx.shadowBlur = 10;
                
                const text = appState.nearestSite ? 
                    `${appState.nearestSite.name} - ${appState.nearestSite.era}` : 
                    'Historical View';
                ctx.fillText(text, canvas.width / 2, 60);

                // Add note
                ctx.font = '16px sans-serif';
                ctx.fillStyle = `rgba(255, 255, 255, ${opacity * 0.7})`;
                ctx.fillText('Historical reconstruction visualization', canvas.width / 2, canvas.height - 40);
            }
        }

        // Event Listeners
        elements.timeSlider.addEventListener('input', (e) => {
            const value = parseInt(e.target.value);
            appState.overlayOpacity = value / 100;
            
            if (appState.historicalImageGenerated) {
                const site = appState.nearestSite;
                if (value === 0) {
                    elements.timeLabel.textContent = 'Present Day (2025)';
                } else {
                    elements.timeLabel.textContent = `${site.era} - ${value}% Historical View`;
                }
                updateOverlay();
            } else {
                elements.timeLabel.textContent = 'Generate historical view first';
            }
        });

        elements.generateBtn.addEventListener('click', generateHistoricalView);

        elements.toggleInfoBtn.addEventListener('click', () => {
            elements.infoPanel.classList.toggle('hidden');
        });

        // Initialize App
        async function initApp() {
            const cameraSuccess = await initCamera();
            if (!cameraSuccess) {
                elements.loadingScreen.querySelector('p').textContent = 'Camera access denied';
                return;
            }

            await initLocation();

            // Hide loading screen and show UI
            setTimeout(() => {
                elements.loadingScreen.classList.add('hidden');
                elements.uiContainer.classList.remove('hidden');
            }, 1500);

            // Start animation loop
            function animate() {
                updateOverlay();
                requestAnimationFrame(animate);
            }
            animate();
        }

        // Start when page loads
        window.addEventListener('load', initApp);

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (appState.cameraStream) {
                appState.cameraStream.getTracks().forEach(track => track.stop());
            }
        });
    </script>
</body>
</html>
